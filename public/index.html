<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two Left Feet Studio</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&family=Poppins:wght@300;400;500;600&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    <style>
        :root {
            --teal: #20B2AA;
            --yellow: #FFD700;
            --coral: #FF6B8A;
            --lilac: #DDA0DD;
            --charcoal: #2C3E50;
            --white: #FFFFFF;
            --light-gray: #F8F9FA;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--light-gray) 0%, #E8F4F8 100%);
            min-height: 100vh;
            color: var(--charcoal);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .admin-container {
            max-width: 1000px;
        }

        .display-container {
            max-width: 100vw;
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            font-family: 'Fredoka', sans-serif;
            font-size: 2.5em;
            font-weight: 600;
            color: var(--teal);
            margin-bottom: 10px;
        }

        .tagline {
            font-family: 'Dancing Script', cursive;
            font-size: 1.5em;
            color: var(--coral);
            font-weight: 600;
        }

        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .welcome-text {
            text-align: center;
            font-size: 1.3em;
            color: var(--charcoal);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--charcoal);
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #E0E0E0;
            border-radius: 12px;
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--teal);
        }

        .btn {
            background: var(--teal);
            color: var(--white);
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            background: #1A9B96;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--coral);
        }

        .btn-secondary:hover {
            background: #FF5577;
        }

        .btn-yellow {
            background: var(--yellow);
            color: var(--charcoal);
        }

        .btn-yellow:hover {
            background: #FFC700;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .poll-options {
            display: grid;
            gap: 15px;
            margin: 20px 0;
        }

        .poll-option {
            background: var(--light-gray);
            border: 2px solid #E0E0E0;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .poll-option:hover {
            border-color: var(--teal);
            background: #E8F4F8;
        }

        .poll-option.selected {
            background: var(--teal);
            color: var(--white);
            border-color: var(--teal);
        }

        .results-container {
            margin-top: 30px;
        }

        .result-item {
            margin-bottom: 20px;
        }

        .result-label {
            font-weight: 500;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .result-bar {
            height: 30px;
            background: var(--light-gray);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .result-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--teal) 0%, var(--coral) 100%);
            border-radius: 15px;
            transition: width 0.5s ease;
            position: relative;
        }

        .result-percentage {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--white);
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .floating-contact {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--coral);
            color: var(--white);
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 107, 138, 0.4);
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            z-index: 1000;
        }

        .floating-contact:hover {
            background: #FF5577;
            transform: translateY(-2px);
        }

        .admin-header {
            background: var(--charcoal);
            color: var(--white);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .admin-title {
            font-family: 'Fredoka', sans-serif;
            font-size: 2em;
            margin-bottom: 5px;
        }

        .admin-subtitle {
            opacity: 0.8;
        }

        .admin-section {
            background: var(--white);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .admin-section h3 {
            font-family: 'Fredoka', sans-serif;
            color: var(--teal);
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .question-form {
            display: grid;
            gap: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .options-container {
            border: 2px dashed #E0E0E0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }

        .option-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .option-item input {
            flex: 1;
        }

        .questions-list {
            margin-top: 30px;
        }

        .question-item {
            background: var(--light-gray);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
        }

        .question-item:hover {
            border-color: var(--teal);
        }

        .question-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .question-title {
            font-weight: 600;
            color: var(--charcoal);
            margin-right: 10px;
        }

        .question-type {
            background: var(--teal);
            color: var(--white);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .question-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .hidden {
            display: none !important;
        }

        .navigation-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(44, 62, 80, 0.8);
            color: var(--white);
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .nav-btn:hover {
            background: var(--charcoal);
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #4CAF50;
        }

        .status-disconnected {
            background: #F44336;
        }

        .display-results {
            font-size: 1.5em;
        }

        .display-results .result-bar {
            height: 50px;
        }

        .display-results .result-label {
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .display-question {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 40px;
            color: var(--charcoal);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .card {
                padding: 20px;
                margin-bottom: 15px;
            }

            .logo {
                font-size: 2em;
            }

            .tagline {
                font-size: 1.2em;
            }

            .welcome-text {
                font-size: 1.1em;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .question-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .question-actions {
                flex-wrap: wrap;
            }

            .display-question {
                font-size: 1.8em;
                margin-bottom: 30px;
            }

            .floating-contact {
                bottom: 15px;
                right: 15px;
                padding: 10px 16px;
                font-size: 0.85em;
            }

            .navigation-controls {
                bottom: 15px;
                left: 15px;
                flex-direction: column;
                gap: 8px;
            }

            .nav-btn {
                padding: 8px 12px;
                font-size: 0.8em;
            }

            .admin-container {
                max-width: 100%;
                padding: 10px;
            }

            .admin-section {
                padding: 20px;
            }

            .btn {
                padding: 12px 24px;
                font-size: 1em;
            }

            .input-group input, .input-group select, .input-group textarea {
                padding: 12px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .poll-option {
                padding: 12px;
                font-size: 1em;
            }

            .result-bar {
                height: 25px;
            }

            .display-results .result-bar {
                height: 40px;
            }

            .question-item {
                padding: 15px;
            }

            .option-item {
                flex-direction: column;
                gap: 8px;
            }

            .option-item input {
                margin-bottom: 0;
            }
        }

        @media (max-width: 480px) {
            .logo {
                font-size: 1.8em;
            }

            .tagline {
                font-size: 1.1em;
            }

            .display-question {
                font-size: 1.5em;
            }

            .floating-contact {
                position: fixed;
                bottom: 10px;
                right: 10px;
                left: 10px;
                border-radius: 12px;
                text-align: center;
            }

            .navigation-controls {
                bottom: 70px; /* Above the contact button */
                left: 10px;
                right: 10px;
                flex-direction: row;
                justify-content: space-between;
            }

            .card {
                border-radius: 15px;
                padding: 18px;
            }

            .admin-section {
                padding: 15px;
                border-radius: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Participant View -->
    <div id="participantView" class="container">
        <div class="header">
            <div class="logo">🩰 Two Left Feet Studio</div>
            <div class="tagline">Get ready to wiggle, wobble, and shine with us!</div>
        </div>

        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="card">
            <div class="welcome-text">
                Welcome to our interactive presentation! Join the fun and let your voice be heard.
            </div>
            <div class="input-group">
                <label for="participantName">Enter your name to join the fun (optional):</label>
                <input type="text" id="participantName" placeholder="Your name here...">
            </div>
            <button class="btn" onclick="joinPresentation()">Let's Dance! 🕺💃</button>
        </div>

        <!-- Waiting Screen -->
        <div id="waitingScreen" class="card hidden">
            <div class="welcome-text">
                <span id="welcomeMessage">Welcome! </span>We're getting ready for the next interaction. Stay tuned!
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <div style="font-size: 3em;">🎪</div>
                <p style="margin-top: 15px; color: var(--coral); font-weight: 500;">Waiting for the next question...</p>
            </div>
        </div>

        <!-- Question Screen -->
        <div id="questionScreen" class="card hidden">
            <h2 id="questionTitle" style="color: var(--teal); margin-bottom: 20px;"></h2>
            <p id="questionText" style="font-size: 1.2em; margin-bottom: 25px;"></p>
            
            <!-- Poll Options -->
            <div id="pollOptions" class="poll-options hidden"></div>
            
            <!-- Text Input -->
            <div id="textInput" class="input-group hidden">
                <textarea id="textResponse" placeholder="Share your thoughts..." rows="4"></textarea>
            </div>
            
            <!-- Submit Button -->
            <button id="submitBtn" class="btn" onclick="submitResponse()">Submit Response</button>
            
            <!-- Results -->
            <div id="results" class="results-container hidden">
                <h3 style="color: var(--teal); margin-bottom: 20px;">Live Results:</h3>
                <div id="resultsContent"></div>
            </div>
        </div>

        <!-- Contact Screen -->
        <div id="contactScreen" class="card hidden">
            <h2 style="color: var(--coral); margin-bottom: 20px;">Stay Connected! 📧</h2>
            <p style="margin-bottom: 25px;">We'd love to keep in touch and share more about our dance programs.</p>
            
            <div class="input-group">
                <label for="contactName">Name *</label>
                <input type="text" id="contactName" required>
            </div>
            
            <div class="input-group">
                <label for="contactEmail">Email *</label>
                <input type="email" id="contactEmail" required>
            </div>
            
            <div class="input-group">
                <label for="contactStudio">Preferred Studio Location *</label>
                <input type="text" id="contactStudio" placeholder="e.g., Downtown, Suburbs, Online" required>
            </div>
            
            <button class="btn btn-secondary" onclick="submitContact()">Join Our Dance Family! 💃</button>
            <button class="btn btn-yellow" onclick="closeContact()">Maybe Later</button>
        </div>

        <!-- Navigation Controls -->
        <div class="navigation-controls">
            <button class="nav-btn" onclick="previousQuestion()">⬅ Previous</button>
            <button class="nav-btn" onclick="nextQuestion()">Next ➡</button>
        </div>

        <!-- Floating Contact Button -->
        <button class="floating-contact" onclick="showContact()">Add Contact</button>
    </div>

    <!-- Admin Panel -->
    <div id="adminView" class="container admin-container hidden">
        <div class="admin-header">
            <div class="admin-title">🩰 Admin Panel</div>
            <div class="admin-subtitle">Two Left Feet Studio Presentation Control</div>
            <div style="margin-top: 10px;">
                <span class="status-indicator status-disconnected" id="connectionStatus"></span>
                <span id="connectionText">Connecting to database...</span>
            </div>
        </div>

        <!-- Create Question Section -->
        <div class="admin-section">
            <h3>Create New Question</h3>
            <form class="question-form" id="questionForm">
                <div class="form-row">
                    <div class="input-group">
                        <label for="questionType">Question Type</label>
                        <select id="questionType" onchange="toggleQuestionOptions()">
                            <option value="poll">Poll (Multiple Choice)</option>
                            <option value="text">Text Response</option>
                            <option value="info">Information Display</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="questionOrder">Display Order</label>
                        <input type="number" id="questionOrder" min="1" value="1">
                    </div>
                </div>

                <div class="input-group">
                    <label for="questionTitleInput">Question Title (matches slide title)</label>
                    <input type="text" id="questionTitleInput" placeholder="e.g., Poll 1, Q&A 2, Vote 3" required>
                </div>

                <div class="input-group">
                    <label for="questionTextInput">Question Text</label>
                    <textarea id="questionTextInput" placeholder="Enter your question or information here..." rows="3" required></textarea>
                </div>

                <!-- Poll Options -->
                <div id="pollOptionsContainer" class="options-container">
                    <label>Answer Options</label>
                    <div id="optionsList">
                        <div class="option-item">
                            <input type="text" placeholder="Option 1" class="option-input">
                            <button type="button" class="btn btn-secondary btn-small" onclick="removeOption(this)">Remove</button>
                        </div>
                        <div class="option-item">
                            <input type="text" placeholder="Option 2" class="option-input">
                            <button type="button" class="btn btn-secondary btn-small" onclick="removeOption(this)">Remove</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-yellow btn-small" onclick="addOption()">Add Option</button>
                </div>

                <button type="submit" class="btn">Save Question</button>
            </form>
        </div>

        <!-- Current Question Status -->
        <div class="admin-section">
            <h3>Current Status</h3>
            <div id="currentQuestionStatus">
                <p><strong>Active Question:</strong> <span id="activeQuestionTitle">None</span></p>
                <p><strong>Response Count:</strong> <span id="responseCount">0</span></p>
                <button class="btn btn-secondary" onclick="refreshCurrentQuestion()">Refresh Status</button>
            </div>
        </div>

        <!-- Saved Questions -->
        <div class="admin-section">
            <h3>Saved Questions</h3>
            <div id="questionsList" class="questions-list">
                <!-- Questions will be populated here -->
            </div>
            <button class="btn btn-yellow" onclick="loadQuestions()">Refresh Questions</button>
        </div>

        <!-- Export Data -->
        <div class="admin-section">
            <h3>Export Data</h3>
            <button class="btn btn-secondary" onclick="exportContacts()">Export Contacts (CSV)</button>
            <button class="btn btn-yellow" onclick="exportResponses()">Export All Responses (CSV)</button>
        </div>
    </div>

    <!-- Display Panel -->
    <div id="displayView" class="container display-container hidden">
        <div class="header">
            <div class="logo" style="font-size: 4em;">🩰 Two Left Feet Studio</div>
        </div>

        <div id="displayContent" class="card">
            <div id="displayQuestion" class="display-question">Waiting for next question...</div>
            <div id="displayResults" class="results-container display-results hidden"></div>
        </div>
    </div>

    <script>
        // Configuration - Replace these with your actual Supabase values
        const SUPABASE_CONFIG = {
            url: 'YOUR_PROJECT_URL_HERE',  // Replace with your Project URL
            anonKey: 'YOUR_ANON_KEY_HERE',  // Replace with your anon key
            serviceKey: 'YOUR_SERVICE_KEY_HERE'  // Replace with your service key
        };

        // Initialize Supabase
        let supabase;
        let adminSupabase;
        let presentationId;
        let currentUser = null;
        let currentQuestion = null;
        let hasSubmittedResponse = false;

        // Initialize the app
        async function initializeApp() {
            try {
                // Check if configuration is set
                if (SUPABASE_CONFIG.url === 'YOUR_PROJECT_URL_HERE') {
                    alert('Please configure your Supabase credentials in the code before using the app!');
                    return;
                }

                // Initialize Supabase clients
                supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                adminSupabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.serviceKey);

                // Get presentation ID
                const { data: presentations, error } = await supabase
                    .from('presentations')
                    .select('id')
                    .eq('is_active', true)
                    .single();

                if (error) throw error;
                presentationId = presentations.id;

                // Determine view mode - CHECK MULTIPLE WAYS
                const urlParams = new URLSearchParams(window.location.search);
                const adminParam = urlParams.get('admin');
                const displayParam = urlParams.get('display');
                
                console.log('URL Parameters:', {
                    admin: adminParam,
                    display: displayParam,
                    fullURL: window.location.href
                });

                if (adminParam === 'twoleftfeet2024') {
                    console.log('Loading ADMIN view');
                    showAdminView();
                } else if (displayParam === 'true') {
                    console.log('Loading DISPLAY view');
                    showDisplayView();
                } else {
                    console.log('Loading PARTICIPANT view');
                    showParticipantView();
                }

                // Set up real-time sync
                setupRealTimeSync();

                console.log('App initialized successfully');
            } catch (error) {
                console.error('Failed to initialize app:', error);
                alert('Failed to connect to database. Please check your internet connection and try refreshing the page.');
            }
        }

        // Show different views
        function showParticipantView() {
            document.getElementById('participantView').classList.remove('hidden');
            document.getElementById('adminView').classList.add('hidden');
            document.getElementById('displayView').classList.add('hidden');
        }

        function showAdminView() {
            document.getElementById('participantView').classList.add('hidden');
            document.getElementById('adminView').classList.remove('hidden');
            document.getElementById('displayView').classList.add('hidden');
            
            updateConnectionStatus(true);
            loadQuestions();
            refreshCurrentQuestion();
        }

        function showDisplayView() {
            document.getElementById('participantView').classList.add('hidden');
            document.getElementById('adminView').classList.add('hidden');
            document.getElementById('displayView').classList.remove('hidden');
        }

        // Real-time synchronization
        function setupRealTimeSync() {
            // Listen for sync state changes
            supabase
                .channel('sync_state')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'sync_state' },
                    handleSyncChange
                )
                .subscribe();

            // Listen for new responses
            supabase
                .channel('responses')
                .on('postgres_changes',
                    { event: 'INSERT', schema: 'public', table: 'responses' },
                    handleNewResponse
                )
                .subscribe();
        }

        async function handleSyncChange(payload) {
            console.log('Sync state changed:', payload);
            
            if (payload.new && payload.new.current_question_id) {
                await loadCurrentQuestion(payload.new.current_question_id);
            }
        }

        function handleNewResponse(payload) {
            console.log('New response received:', payload);
            if (currentQuestion && payload.new.question_id === currentQuestion.id) {
                loadQuestionResults(currentQuestion.id);
            }
        }

        // Participant functions
        function joinPresentation() {
            const name = document.getElementById('participantName').value.trim();
            currentUser = name || 'Anonymous';
            
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('waitingScreen').classList.remove('hidden');
            document.getElementById('welcomeMessage').textContent = name ? `Welcome, ${name}! ` : 'Welcome! ';
            
            // Check for current question
            checkCurrentQuestion();
        }

        async function checkCurrentQuestion() {
            try {
                const { data, error } = await supabase
                    .from('sync_state')
                    .select('current_question_id')
                    .eq('presentation_id', presentationId)
                    .single();

                if (data && data.current_question_id) {
                    await loadCurrentQuestion(data.current_question_id);
                }
            } catch (error) {
                console.log('No current question found');
            }
        }

        async function loadCurrentQuestion(questionId) {
            try {
                const { data: question, error } = await supabase
                    .from('questions')
                    .select('*')
                    .eq('id', questionId)
                    .single();

                if (error) throw error;

                currentQuestion = question;
                hasSubmittedResponse = false;
                showQuestion(question);
                
                // Load existing results
                await loadQuestionResults(questionId);
                
            } catch (error) {
                console.error('Error loading current question:', error);
            }
        }

        function showQuestion(question) {
            // Hide other screens
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('waitingScreen').classList.add('hidden');
            document.getElementById('contactScreen').classList.add('hidden');
            document.getElementById('questionScreen').classList.remove('hidden');

            // Populate question content
            document.getElementById('questionTitle').textContent = question.title;
            document.getElementById('questionText').textContent = question.question_text;

            // Reset form
            document.getElementById('results').classList.add('hidden');
            document.getElementById('submitBtn').style.display = 'block';

            // Show appropriate input type
            if (question.question_type === 'poll') {
                showPollOptions(question.options);
                document.getElementById('textInput').classList.add('hidden');
            } else if (question.question_type === 'text') {
                document.getElementById('pollOptions').classList.add('hidden');
                document.getElementById('textInput').classList.remove('hidden');
                document.getElementById('textResponse').value = '';
            } else if (question.question_type === 'info') {
                document.getElementById('pollOptions').classList.add('hidden');
                document.getElementById('textInput').classList.add('hidden');
                document.getElementById('submitBtn').style.display = 'none';
                document.getElementById('results').classList.remove('hidden');
            }
        }

        function showPollOptions(options) {
            const container = document.getElementById('pollOptions');
            container.classList.remove('hidden');
            container.innerHTML = '';

            options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'poll-option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectPollOption(optionDiv, option);
                container.appendChild(optionDiv);
            });
        }

        function selectPollOption(element, value) {
            // Clear previous selections
            document.querySelectorAll('.poll-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Select current option
            element.classList.add('selected');
            element.dataset.selected = value;
        }

        async function submitResponse() {
            if (!currentQuestion || hasSubmittedResponse) return;

            let responseValue = '';

            if (currentQuestion.question_type === 'poll') {
                const selected = document.querySelector('.poll-option.selected');
                if (!selected) {
                    alert('Please select an option before submitting.');
                    return;
                }
                responseValue = selected.dataset.selected;
            } else if (currentQuestion.question_type === 'text') {
                responseValue = document.getElementById('textResponse').value.trim();
                if (!responseValue) {
                    alert('Please enter a response before submitting.');
                    return;
                }
            }

            try {
                const { error } = await supabase
                    .from('responses')
                    .insert({
                        question_id: currentQuestion.id,
                        participant_name: currentUser,
                        response_value: responseValue
                    });

                if (error) throw error;

                hasSubmittedResponse = true;
                document.getElementById('submitBtn').style.display = 'none';
                
                // Show results
                document.getElementById('results').classList.remove('hidden');
                await loadQuestionResults(currentQuestion.id);

                // Show thank you message briefly
                const originalText = document.getElementById('submitBtn').textContent;
                document.getElementById('submitBtn').textContent = 'Response Submitted! ✨';
                document.getElementById('submitBtn').style.display = 'block';
                document.getElementById('submitBtn').disabled = true;
                
            } catch (error) {
                console.error('Error submitting response:', error);
                alert('Failed to submit response. Please try again.');
            }
        }

        async function loadQuestionResults(questionId) {
            try {
                const { data: responses, error } = await supabase
                    .from('responses')
                    .select('response_value')
                    .eq('question_id', questionId);

                if (error) throw error;

                displayResults(responses, currentQuestion);
                
                // Update admin response count if in admin view
                if (!document.getElementById('adminView').classList.contains('hidden')) {
                    document.getElementById('responseCount').textContent = responses.length;
                }
                
            } catch (error) {
                console.error('Error loading results:', error);
            }
        }

        function displayResults(responses, question) {
            const container = document.getElementById('resultsContent');
            const displayContainer = document.getElementById('displayResults');
            
            if (question.question_type === 'poll') {
                const results = calculatePollResults(responses, question.options);
                const html = generatePollResultsHTML(results, responses.length);
                container.innerHTML = html;
                displayContainer.innerHTML = html;
                
                // Update display view
                if (!document.getElementById('displayView').classList.contains('hidden')) {
                    document.getElementById('displayQuestion').textContent = question.question_text;
                    document.getElementById('displayResults').classList.remove('hidden');
                }
                
            } else if (question.question_type === 'text') {
                const html = generateTextResultsHTML(responses);
                container.innerHTML = html;
                displayContainer.innerHTML = html;
            }
        }

        function calculatePollResults(responses, options) {
            const counts = {};
            options.forEach(option => counts[option] = 0);
            
            responses.forEach(response => {
                if (counts.hasOwnProperty(response.response_value)) {
                    counts[response.response_value]++;
                }
            });
            
            return counts;
        }

        function generatePollResultsHTML(results, totalResponses) {
            let html = '';
            
            Object.entries(results).forEach(([option, count]) => {
                const percentage = totalResponses > 0 ? Math.round((count / totalResponses) * 100) : 0;
                html += `
                    <div class="result-item">
                        <div class="result-label">
                            <span>${option}</span>
                            <span>${count} votes</span>
                        </div>
                        <div class="result-bar">
                            <div class="result-fill" style="width: ${percentage}%">
                                <div class="result-percentage">${percentage}%</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        function generateTextResultsHTML(responses) {
            if (responses.length === 0) {
                return '<p style="text-align: center; color: #999;">No responses yet...</p>';
            }
            
            let html = `<h4>Responses (${responses.length}):</h4><div style="max-height: 300px; overflow-y: auto;">`;
            
            responses.forEach(response => {
                const name = response.participant_name || 'Anonymous';
                html += `
                    <div style="background: var(--light-gray); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>${name}:</strong> ${response.response_value}
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // Contact functions
        function showContact() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('waitingScreen').classList.add('hidden');
            document.getElementById('questionScreen').classList.add('hidden');
            document.getElementById('contactScreen').classList.remove('hidden');
        }

        function closeContact() {
            document.getElementById('contactScreen').classList.add('hidden');
            
            // Return to appropriate screen
            if (currentQuestion) {
                document.getElementById('questionScreen').classList.remove('hidden');
            } else if (currentUser) {
                document.getElementById('waitingScreen').classList.remove('hidden');
            } else {
                document.getElementById('welcomeScreen').classList.remove('hidden');
            }
        }

        async function submitContact() {
            const name = document.getElementById('contactName').value.trim();
            const email = document.getElementById('contactEmail').value.trim();
            const studio = document.getElementById('contactStudio').value.trim();

            if (!name || !email || !studio) {
                alert('Please fill in all required fields.');
                return;
            }

            try {
                const { error } = await supabase
                    .from('contacts')
                    .insert({
                        presentation_id: presentationId,
                        name: name,
                        email: email,
                        studio: studio
                    });

                if (error) throw error;

                alert('Thank you! We\'ll be in touch soon! 💃');
                
                // Clear form
                document.getElementById('contactName').value = '';
                document.getElementById('contactEmail').value = '';
                document.getElementById('contactStudio').value = '';
                
                closeContact();
                
            } catch (error) {
                console.error('Error submitting contact:', error);
                alert('Failed to submit contact information. Please try again.');
            }
        }

        // Navigation functions
        async function nextQuestion() {
            if (!currentQuestion) return;
            
            try {
                const { data: questions, error } = await supabase
                    .from('questions')
                    .select('*')
                    .eq('presentation_id', presentationId)
                    .order('display_order');

                if (error) throw error;

                const currentIndex = questions.findIndex(q => q.id === currentQuestion.id);
                if (currentIndex < questions.length - 1) {
                    await updateSyncState(questions[currentIndex + 1].id);
                }
                
            } catch (error) {
                console.error('Error navigating to next question:', error);
            }
        }

        async function previousQuestion() {
            if (!currentQuestion) return;
            
            try {
                const { data: questions, error } = await supabase
                    .from('questions')
                    .select('*')
                    .eq('presentation_id', presentationId)
                    .order('display_order');

                if (error) throw error;

                const currentIndex = questions.findIndex(q => q.id === currentQuestion.id);
                if (currentIndex > 0) {
                    await updateSyncState(questions[currentIndex - 1].id);
                }
                
            } catch (error) {
                console.error('Error navigating to previous question:', error);
            }
        }

        async function updateSyncState(questionId) {
            try {
                const { error } = await adminSupabase
                    .from('sync_state')
                    .upsert({
                        presentation_id: presentationId,
                        current_question_id: questionId,
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;
                
            } catch (error) {
                console.error('Error updating sync state:', error);
            }
        }

        // Admin functions
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                indicator.className = 'status-indicator status-connected';
                text.textContent = 'Connected to database';
            } else {
                indicator.className = 'status-indicator status-disconnected';
                text.textContent = 'Disconnected from database';
            }
        }

        function toggleQuestionOptions() {
            const type = document.getElementById('questionType').value;
            const container = document.getElementById('pollOptionsContainer');
            
            if (type === 'poll') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        function addOption() {
            const container = document.getElementById('optionsList');
            const optionCount = container.children.length + 1;
            
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item';
            optionDiv.innerHTML = `
                <input type="text" placeholder="Option ${optionCount}" class="option-input">
                <button type="button" class="btn btn-secondary btn-small" onclick="removeOption(this)">Remove</button>
            `;
            
            container.appendChild(optionDiv);
        }

        function removeOption(button) {
            const container = document.getElementById('optionsList');
            if (container.children.length > 2) {
                button.parentElement.remove();
            } else {
                alert('You must have at least 2 options for a poll.');
            }
        }

        async function saveQuestion(event) {
            event.preventDefault();
            
            const type = document.getElementById('questionType').value;
            const title = document.getElementById('questionTitleInput').value.trim();
            const text = document.getElementById('questionTextInput').value.trim();
            const order = parseInt(document.getElementById('questionOrder').value);

            if (!title || !text) {
                alert('Please fill in all required fields.');
                return;
            }

            let options = [];
            if (type === 'poll') {
                const optionInputs = document.querySelectorAll('.option-input');
                options = Array.from(optionInputs)
                    .map(input => input.value.trim())
                    .filter(value => value.length > 0);
                
                if (options.length < 2) {
                    alert('Please provide at least 2 options for a poll.');
                    return;
                }
            }

            try {
                const { error } = await adminSupabase
                    .from('questions')
                    .insert({
                        presentation_id: presentationId,
                        title: title,
                        question_text: text,
                        question_type: type,
                        options: options,
                        display_order: order
                    });

                if (error) throw error;

                alert('Question saved successfully! ✨');
                
                // Reset form
                document.getElementById('questionForm').reset();
                document.getElementById('questionOrder').value = '1';
                toggleQuestionOptions();
                
                // Refresh questions list
                await loadQuestions();
                
            } catch (error) {
                console.error('Error saving question:', error);
                alert('Failed to save question. Please try again.');
            }
        }

        async function loadQuestions() {
            try {
                const { data: questions, error } = await supabase
                    .from('questions')
                    .select('*')
                    .eq('presentation_id', presentationId)
                    .order('display_order');

                if (error) throw error;

                displayQuestionsList(questions);
                
            } catch (error) {
                console.error('Error loading questions:', error);
            }
        }

        function displayQuestionsList(questions) {
            const container = document.getElementById('questionsList');
            
            if (questions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No questions created yet. Create your first question above!</p>';
                return;
            }

            let html = '';
            questions.forEach(question => {
                html += `
                    <div class="question-item">
                        <div class="question-header">
                            <div>
                                <span class="question-title">${question.title}</span>
                                <span class="question-type">${question.question_type.toUpperCase()}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="margin: 0;">Order:</label>
                                <input type="number" value="${question.display_order}" 
                                       onchange="updateQuestionOrder('${question.id}', this.value)"
                                       style="width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                        <p style="margin: 10px 0; color: #666;">${question.question_text}</p>
                        ${question.question_type === 'poll' ? 
                            `<p><strong>Options:</strong> ${question.options.join(', ')}</p>` : ''}
                        <div class="question-actions">
                            <button class="btn btn-small" onclick="activateQuestion('${question.id}')">Activate</button>
                            <button class="btn btn-yellow btn-small" onclick="editQuestion('${question.id}')">Edit</button>
                            <button class="btn btn-secondary btn-small" onclick="deleteQuestion('${question.id}')">Delete</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function updateQuestionOrder(questionId, newOrder) {
            try {
                const { error } = await adminSupabase
                    .from('questions')
                    .update({ display_order: parseInt(newOrder) })
                    .eq('id', questionId);

                if (error) throw error;
                
                // Refresh questions list to show new order
                await loadQuestions();
                
            } catch (error) {
                console.error('Error updating question order:', error);
                alert('Failed to update question order.');
            }
        }

        async function activateQuestion(questionId) {
            try {
                await updateSyncState(questionId);
                alert('Question activated! All participants will see this question now.');
                await refreshCurrentQuestion();
                
            } catch (error) {
                console.error('Error activating question:', error);
                alert('Failed to activate question.');
            }
        }

        async function deleteQuestion(questionId) {
            if (!confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
                return;
            }

            try {
                const { error } = await adminSupabase
                    .from('questions')
                    .delete()
                    .eq('id', questionId);

                if (error) throw error;

                alert('Question deleted successfully.');
                await loadQuestions();
                
            } catch (error) {
                console.error('Error deleting question:', error);
                alert('Failed to delete question.');
            }
        }

        function editQuestion(questionId) {
            alert('Edit functionality coming soon! For now, please create a new question and delete the old one.');
        }

        async function refreshCurrentQuestion() {
            try {
                const { data, error } = await supabase
                    .from('sync_state')
                    .select(`
                        current_question_id,
                        questions:current_question_id (
                            title,
                            question_text
                        )
                    `)
                    .eq('presentation_id', presentationId)
                    .single();

                if (error || !data || !data.current_question_id) {
                    document.getElementById('activeQuestionTitle').textContent = 'None';
                    document.getElementById('responseCount').textContent = '0';
                    return;
                }

                document.getElementById('activeQuestionTitle').textContent = 
                    data.questions ? data.questions.title : 'Unknown';

                // Get response count
                const { data: responses, error: responseError } = await supabase
                    .from('responses')
                    .select('id')
                    .eq('question_id', data.current_question_id);

                if (!responseError) {
                    document.getElementById('responseCount').textContent = responses.length;
                }
                
            } catch (error) {
                console.error('Error refreshing current question:', error);
            }
        }

        // Export functions
        async function exportContacts() {
            try {
                const { data: contacts, error } = await adminSupabase
                    .from('contacts')
                    .select('*')
                    .eq('presentation_id', presentationId)
                    .order('created_at');

                if (error) throw error;

                if (contacts.length === 0) {
                    alert('No contact information to export.');
                    return;
                }

                const csv = convertToCSV(contacts, ['name', 'email', 'studio', 'created_at']);
                downloadCSV(csv, 'two_left_feet_contacts.csv');
                
            } catch (error) {
                console.error('Error exporting contacts:', error);
                alert('Failed to export contacts.');
            }
        }

        async function exportResponses() {
            try {
                const { data: responses, error } = await adminSupabase
                    .from('responses')
                    .select(`
                        *,
                        questions (title, question_text, question_type)
                    `)
                    .eq('questions.presentation_id', presentationId)
                    .order('created_at');

                if (error) throw error;

                if (responses.length === 0) {
                    alert('No responses to export.');
                    return;
                }

                // Flatten the data for CSV
                const flatData = responses.map(response => ({
                    question_title: response.questions?.title || 'Unknown',
                    question_text: response.questions?.question_text || 'Unknown',
                    question_type: response.questions?.question_type || 'Unknown',
                    participant_name: response.participant_name || 'Anonymous',
                    response_value: response.response_value,
                    created_at: response.created_at
                }));

                const csv = convertToCSV(flatData, ['question_title', 'question_text', 'question_type', 'participant_name', 'response_value', 'created_at']);
                downloadCSV(csv, 'two_left_feet_responses.csv');
                
            } catch (error) {
                console.error('Error exporting responses:', error);
                alert('Failed to export responses.');
            }
        }

        function convertToCSV(data, columns) {
            const header = columns.join(',');
            const rows = data.map(row => 
                columns.map(col => {
                    const value = row[col] || '';
                    // Escape quotes and wrap in quotes if contains comma
                    return typeof value === 'string' && (value.includes(',') || value.includes('"')) 
                        ? `"${value.replace(/"/g, '""')}"` 
                        : value;
                }).join(',')
            );
            
            return [header, ...rows].join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Event listeners
        document.getElementById('questionForm').addEventListener('submit', saveQuestion);

        // Initialize app when page loads
        window.addEventListener('load', initializeApp);

        // Configuration warning
        if (typeof window !== 'undefined' && SUPABASE_CONFIG.url === 'YOUR_PROJECT_URL_HERE') {
            console.warn('⚠️ CONFIGURATION REQUIRED: Please update the SUPABASE_CONFIG object with your actual Supabase credentials!');
        }
    </script>
</body>
</html>