<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Two Left Feet Studio - Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&family=Nunito:wght@300;400;600;700&family=Caveat:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
--teal: #20B2AA;
--sunshine-yellow: #FFD700;
--bubblegum-coral: #FF7F7F;
--soft-lilac: #DDA0DD;
--sky-blue: #87CEEB;
--dark-charcoal: #2F2F2F;
--white: #FFFFFF;
--light-gray: #F8F9FA;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Nunito', sans-serif;
background: linear-gradient(135deg, var(--light-gray) 0%, var(--white) 100%);
min-height: 100vh;
color: var(--dark-charcoal);
padding: 20px;
}

.container {
max-width: 1000px;
margin: 0 auto;
}

.logo {
font-family: 'Fredoka One', cursive;
font-size: 2.5rem;
color: var(--teal);
margin-bottom: 10px;
text-align: center;
}

.tagline {
font-family: 'Caveat', cursive;
font-size: 1.2rem;
color: var(--bubblegum-coral);
margin-bottom: 30px;
text-align: center;
}

.card {
background: white;
border-radius: 15px;
padding: 20px;
margin-bottom: 20px;
box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.sync-status {
background: var(--sunshine-yellow);
color: var(--dark-charcoal);
padding: 8px 15px;
border-radius: 8px;
font-size: 0.9rem;
margin-bottom: 15px;
text-align: center;
}

.current-slide {
background: var(--teal);
color: white;
padding: 10px;
border-radius: 10px;
margin-bottom: 20px;
text-align: center;
font-weight: 600;
}

.form-group {
margin-bottom: 20px;
}

.form-group label {
display: block;
margin-bottom: 5px;
font-weight: 600;
color: var(--dark-charcoal);
}

.form-group input, .form-group select, .form-group textarea {
width: 100%;
padding: 10px;
border: 2px solid var(--soft-lilac);
border-radius: 8px;
font-family: 'Nunito', sans-serif;
}

.options-container {
border: 2px dashed var(--soft-lilac);
padding: 15px;
border-radius: 8px;
margin-top: 10px;
}

.option-input {
display: flex;
margin-bottom: 10px;
gap: 10px;
}

.btn {
background: var(--teal);
color: white;
border: none;
padding: 10px 20px;
border-radius: 8px;
font-size: 1rem;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
font-family: 'Nunito', sans-serif;
}

.btn:hover {
background: var(--bubblegum-coral);
transform: translateY(-2px);
}

.add-option, .delete-btn {
padding: 8px 15px;
border: none;
border-radius: 5px;
cursor: pointer;
font-size: 0.9rem;
}

.add-option {
background: var(--sunshine-yellow);
color: var(--dark-charcoal);
}

.delete-btn {
background: var(--bubblegum-coral);
color: white;
}

.question-item {
background: var(--light-gray);
padding: 15px;
border-radius: 10px;
margin-bottom: 10px;
display: flex;
justify-content: space-between;
align-items: center;
}

.backup-controls {
margin-top: 30px;
padding-top: 20px;
border-top: 2px dashed var(--soft-lilac);
}

.backup-controls h3 {
margin-bottom: 15px;
color: var(--teal);
}

.backup-buttons {
display: flex;
gap: 10px;
flex-wrap: wrap;
margin-bottom: 10px;
}

.backup-info {
font-size: 0.9rem;
color: var(--dark-charcoal);
background: var(--light-gray);
padding: 10px;
border-radius: 8px;
}

.storage-status {
background: var(--sky-blue);
color: var(--dark-charcoal);
padding: 8px 15px;
border-radius: 8px;
font-size: 0.9rem;
margin-bottom: 15px;
text-align: center;
font-weight: 600;
}

.save-confirmation {
position: fixed;
top: 20px;
right: 20px;
background: var(--teal);
color: white;
padding: 10px 20px;
border-radius: 8px;
z-index: 1000;
font-weight: 600;
box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
</style>
</head>
<body>
<div class="container">
<div class="logo">Admin Panel</div>
<div class="tagline">Every stumble starts with a plan!</div>

<div class="card">
<div class="sync-status" id="syncStatus">Google Slides sync ready</div>
<div class="current-slide" id="currentSlideDisplay">Current Slide: None</div>
<div class="storage-status" id="storageStatus">Storage: Ready</div>
</div>

<div class="card">
<h2>Create New Interactive Element</h2>
<div class="form-group">
<label for="slideId">Slide Identifier:</label>
<input type="text" id="slideId" placeholder="e.g., Poll 1, Q&A 2, Vote 3">
</div>

<div class="form-group">
<label for="elementType">Type:</label>
<select id="elementType" onchange="updateFormFields()">
<option value="poll">Multiple Choice Poll</option>
<option value="question">Open Text Question</option>
<option value="vote">Voting</option>
<option value="info">Information Display</option>
</select>
</div>

<div class="form-group">
<label for="elementTitle">Title/Question:</label>
<textarea id="elementTitle" rows="3" placeholder="Enter your question or information..."></textarea>
</div>

<div id="optionsContainer" class="options-container">
<label>Answer Options:</label>
<div id="optionsList">
<div class="option-input">
<input type="text" placeholder="Option 1" class="option-text">
<button type="button" class="delete-btn" onclick="removeOption(this)">×</button>
</div>
<div class="option-input">
<input type="text" placeholder="Option 2" class="option-text">
<button type="button" class="delete-btn" onclick="removeOption(this)">×</button>
</div>
</div>
<button type="button" class="add-option" onclick="addOption()">+ Add Option</button>
</div>

<button class="btn" onclick="saveElement()">Save Element</button>

<div class="backup-controls">
<h3>Backup & Restore</h3>
<div class="backup-buttons">
<button type="button" class="btn" onclick="exportQuestions()" style="background: var(--sunshine-yellow); color: var(--dark-charcoal);">
📥 Export Questions
</button>
<button type="button" class="btn" onclick="importQuestions()" style="background: var(--soft-lilac); color: var(--dark-charcoal);">
📤 Import Questions
</button>
<button type="button" class="btn" onclick="testStorage()" style="background: var(--sky-blue); color: var(--dark-charcoal);">
🔧 Test Storage
</button>
</div>
<div class="backup-info">
💡 Export your questions regularly as backup. Import to restore or transfer to another device.
</div>
</div>
</div>

<div class="card">
<h2>Saved Elements</h2>
<div id="savedElements">
<!-- Saved elements will appear here -->
</div>
</div>
</div>

<script>
// Global variables
let presentationElements = {};
let responses = {};

// GLOBAL FUNCTIONS - These need to be accessible to onclick handlers
// Update form fields based on element type
function updateFormFields() {
    const elementType = document.getElementById('elementType').value;
    const optionsContainer = document.getElementById('optionsContainer');

    if (elementType === 'info' || elementType === 'question') {
        optionsContainer.style.display = 'none';
    } else {
        optionsContainer.style.display = 'block';
    }
}

// Add option input
function addOption() {
    const optionsList = document.getElementById('optionsList');
    const optionCount = optionsList.children.length + 1;
    
    if (optionCount <= 5) {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'option-input';
        optionDiv.innerHTML = `
            <input type="text" placeholder="Option ${optionCount}" class="option-text">
            <button type="button" class="delete-btn" onclick="removeOption(this)">×</button>
        `;
        optionsList.appendChild(optionDiv);
    } else {
        alert('Maximum 5 options allowed');
    }
}

// Remove option input
function removeOption(button) {
    const optionsList = document.getElementById('optionsList');
    if (optionsList.children.length > 2) {
        button.parentElement.remove();
    } else {
        alert('Must have at least 2 options');
    }
}

// Save element
function saveElement() {
    const slideId = document.getElementById('slideId').value.trim();
    const elementType = document.getElementById('elementType').value;
    const title = document.getElementById('elementTitle').value.trim();

    if (!slideId || !title) {
        alert('Please fill in the slide identifier and title/question.');
        return;
    }

    const element = {
        id: slideId,
        type: elementType,
        title: title,
        options: [],
        responses: []
    };

    // Only collect options for polls and votes, not for open questions or info
    if (elementType !== 'info' && elementType !== 'question') {
        const optionInputs = document.querySelectorAll('.option-text');
        optionInputs.forEach(input => {
            if (input.value.trim()) {
                element.options.push(input.value.trim());
            }
        });

        if (element.options.length < 2) {
            alert('Please provide at least 2 options for polls and votes.');
            return;
        }
    }

    presentationElements[slideId] = element;
    savePresentationElements();
    loadSavedElements();

    // Clear form
    document.getElementById('slideId').value = '';
    document.getElementById('elementTitle').value = '';
    document.querySelectorAll('.option-text').forEach(input => input.value = '');

    alert('Element saved successfully!');
}

// Delete element
function deleteElement(slideId) {
    if (confirm(`Are you sure you want to delete "${slideId}"?`)) {
        delete presentationElements[slideId];
        savePresentationElements();
        loadSavedElements();
    }
}

// Export questions functionality
function exportQuestions() {
    try {
        const dataToExport = {
            elements: presentationElements,
            exportDate: new Date().toISOString(),
            appVersion: '1.0'
        };

        const dataStr = JSON.stringify(dataToExport, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});

        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `tlf-questions-${new Date().toISOString().split('T')[0]}.json`;
        link.click();

        console.log('✅ Questions exported successfully');
        alert('✅ Questions exported successfully!');

    } catch (error) {
        console.error('❌ Error exporting questions:', error);
        alert('Error exporting questions. Please try again.');
    }
}

// Import questions functionality
function importQuestions() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';

    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);

                // Validate the data structure
                if (importedData.elements && typeof importedData.elements === 'object') {
                    // Confirm before overwriting
                    const currentCount = Object.keys(presentationElements).length;
                    const importCount = Object.keys(importedData.elements).length;

                    const confirmMessage = `This will replace your current ${currentCount} questions with ${importCount} imported questions. Continue?`;

                    if (confirm(confirmMessage)) {
                        presentationElements = importedData.elements;
                        savePresentationElements();
                        loadSavedElements();
                        alert(`✅ Successfully imported ${importCount} questions!`);
                    }
                } else {
                    alert('❌ Invalid file format. Please select a valid TLF questions file.');
                }

            } catch (error) {
                console.error('❌ Error importing questions:', error);
                alert('❌ Error reading file. Please make sure it\'s a valid JSON file.');
            }
        };

        reader.readAsText(file);
    };

    input.click();
}

// Storage test function
function testStorage() {
    const testData = { test: 'storage_test_' + Date.now() };

    try {
        // Test localStorage
        localStorage.setItem('tlf_test', JSON.stringify(testData));
        const retrieved = JSON.parse(localStorage.getItem('tlf_test'));
        localStorage.removeItem('tlf_test');

        if (retrieved.test === testData.test) {
            alert(`✅ Storage is working correctly!\n\nElements saved: ${Object.keys(presentationElements).length}\nLast saved: ${new Date().toLocaleString()}`);
        } else {
            throw new Error('Data mismatch');
        }

    } catch (error) {
        alert(`❌ Storage test failed!\n\nError: ${error.message}\n\nTry using Export/Import for backup.`);
    }
}

// Enhanced storage functions with better persistence and backup
function savePresentationElements() {
    try {
        const dataToSave = {
            elements: presentationElements,
            timestamp: new Date().toISOString(),
            version: '1.0'
        };

        // Primary storage
        localStorage.setItem('tlf_presentation_elements', JSON.stringify(dataToSave));

        // Backup storage (different key)
        localStorage.setItem('tlf_presentation_elements_backup', JSON.stringify(dataToSave));

        console.log('✅ Presentation elements saved successfully');
        updateStorageStatus(`Saved ${Object.keys(presentationElements).length} elements`);
        showSaveConfirmation();

    } catch (error) {
        console.error('❌ Error saving presentation elements:', error);
        updateStorageStatus('Save failed!');
        alert('Warning: Could not save your questions. Please try again or use Export.');
    }
}

function loadPresentationElements() {
    try {
        // Try primary storage first
        let saved = localStorage.getItem('tlf_presentation_elements');

        // If primary fails, try backup
        if (!saved) {
            saved = localStorage.getItem('tlf_presentation_elements_backup');
            console.log('📦 Loaded from backup storage');
        }

        if (saved) {
            const data = JSON.parse(saved);

            // Handle both old format (direct object) and new format (with metadata)
            if (data.elements) {
                presentationElements = data.elements;
                console.log(`✅ Loaded ${Object.keys(data.elements).length} saved elements from ${data.timestamp}`);
                updateStorageStatus(`Loaded ${Object.keys(data.elements).length} elements`);
            } else {
                // Old format compatibility
                presentationElements = data;
                console.log(`✅ Loaded ${Object.keys(data).length} saved elements (legacy format)`);
                updateStorageStatus(`Loaded ${Object.keys(data).length} elements (legacy)`);
            }
        } else {
            console.log('ℹ️ No saved elements found - starting fresh');
            presentationElements = {};
            updateStorageStatus('No saved elements found');
        }

    } catch (error) {
        console.error('❌ Error loading presentation elements:', error);
        presentationElements = {};
        updateStorageStatus('Load failed!');
        alert('Warning: Could not load saved questions. Starting with empty list.');
    }
}

// Update storage status display
function updateStorageStatus(message) {
    const statusEl = document.getElementById('storageStatus');
    if (statusEl) {
        statusEl.textContent = `Storage: ${message}`;
        setTimeout(() => {
            statusEl.textContent = 'Storage: Ready';
        }, 3000);
    }
}

// Add visual confirmation when saving
function showSaveConfirmation() {
    const confirmation = document.createElement('div');
    confirmation.className = 'save-confirmation';
    confirmation.textContent = '✅ Questions saved successfully!';
    document.body.appendChild(confirmation);

    setTimeout(() => {
        confirmation.remove();
    }, 3000);
}

// Load saved elements in admin panel
function loadSavedElements() {
    const container = document.getElementById('savedElements');
    container.innerHTML = '';

    const elementCount = Object.keys(presentationElements).length;

    if (elementCount === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--dark-charcoal); font-style: italic;">No saved elements yet. Create your first interactive element above!</p>';
        return;
    }

    Object.values(presentationElements).forEach(element => {
        const elementDiv = document.createElement('div');
        elementDiv.className = 'question-item';
        elementDiv.innerHTML = `
            <div>
                <strong>${element.id}</strong> (${element.type})<br>
                <small>${element.title}</small>
                ${element.options && element.options.length > 0 ? `<br><small style="color: var(--teal);">${element.options.length} options</small>` : ''}
            </div>
            <button class="delete-btn" onclick="deleteElement('${element.id}')">Delete</button>
        `;
        container.appendChild(elementDiv);
    });

    // Add summary
    const summary = document.createElement('div');
    summary.style.cssText = 'text-align: center; margin-top: 15px; padding: 10px; background: var(--light-gray); border-radius: 8px; font-weight: 600;';
    summary.textContent = `Total: ${elementCount} saved elements`;
    container.appendChild(summary);
}

// Initialize the admin panel
function init() {
    console.log('🔄 Initializing admin panel...');
    loadPresentationElements();
    loadSavedElements();
    updateFormFields();

    // Load current slide if available
    const currentSlideFromStorage = localStorage.getItem('tlf_current_slide');
    if (currentSlideFromStorage) {
        document.getElementById('currentSlideDisplay').textContent = `Current Slide: ${currentSlideFromStorage}`;
    }

    console.log('✅ Admin panel initialized');
}

// Auto-save functionality - save whenever user types (with debouncing)
let autoSaveTimeout;
function setupAutoSave() {
    const inputs = document.querySelectorAll('#slideId, #elementTitle, .option-text');
    inputs.forEach(input => {
        input.addEventListener('input', () => {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                // Only auto-save if we have valid data
                const slideId = document.getElementById('slideId').value.trim();
                const title = document.getElementById('elementTitle').value.trim();
                if (slideId && title) {
                    console.log('💾 Auto-saving draft...');
                    // Could save as draft here if needed
                }
            }, 2000); // Wait 2 seconds after user stops typing
        });
    });
}

// Update sync status
function updateSyncStatus(message) {
    const statusEl = document.getElementById('syncStatus');
    if (statusEl) {
        statusEl.textContent = message;
        setTimeout(() => {
            statusEl.textContent = '📡 Google Slides sync ready';
        }, 3000);
    }
}

// Handle slide changes from Google Slides
function handleSlideSync() {
    const urlParams = new URLSearchParams(window.location.search);
    const slideName = urlParams.get('slideName');

    if (slideName) {
        console.log('📡 Received slide sync:', slideName);
        localStorage.setItem('tlf_current_slide', slideName);
        document.getElementById('currentSlideDisplay').textContent = `Current Slide: ${slideName}`;
        updateSyncStatus(`🔄 Synced: ${slideName}`);
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Check if this is a sync request first
    handleSlideSync();

    // Initialize the admin panel
    init();
    setupAutoSave();

    // Show version info in console
    console.log('🎭 Two Left Feet Studio Admin Panel v1.1');
    console.log('💾 Enhanced storage with backup and export features');
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + S to save current element
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveElement();
    }
        
    // Ctrl/Cmd + E to export
    if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        exportQuestions();
    }
});

// Periodic backup reminder
setInterval(() => {
    const elementCount = Object.keys(presentationElements).length;
    if (elementCount > 0 && elementCount % 5 === 0) {
        const lastBackup = localStorage.getItem('tlf_last_backup');
        const now = Date.now();
        const oneWeek = 7 * 24 * 60 * 60 * 1000;
            
        if (!lastBackup || (now - parseInt(lastBackup)) > oneWeek) {
            if (confirm('💡 Reminder: You have ' + elementCount + ' questions saved. Would you like to export a backup?')) {
                exportQuestions();
                localStorage.setItem('tlf_last_backup', now.toString());
            }
        }
    }
}, 30000); // Check every 30 seconds
</script>
</body>
</html>
